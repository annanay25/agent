---
kind: pipeline
name: Test
platform:
  os: linux
  arch: amd64

steps:
- name: lint
  image: golangci/golangci-lint:v1.37.1
  # libsystemd-dev is required for cgo
  commands:
  - apt-get update -y && apt-get install -y libsystemd-dev
  - make lint

# - name: test
#   image: ubuntu
#   volumes:
#   - name: docker
#     path: /var/run/docker.sock
#   commands:
#   - apt-get update  && apt-get install -y libsystemd-dev
#   - mkdir -p /usr/local/go/bin
#   - wget https://golang.org/dl/go1.16.5.linux-amd64.tar.gz
#   - tar -C /usr/local -xzf go1.16.5.linux-amd64.tar.gz
#   - export PATH=$PATH:/usr/local/go/bin
#   - make cmd/agent/agent cmd/agentctl/agentctl
#   - make test
#   - RELEASE_TAG=v0.0.0 make test-packages


- name: test-ubuntu
  image: ubuntu
  volumes:
  - name: docker
    path: /var/run/docker.sock
  commands:
  - export DEBIAN_FRONTEND=noninteractive 
  - apt-get update -y && apt-get install -y libsystemd-dev  apt-transport-https ca-certificates curl gnupg lsb-release wget make build-essential
  - mkdir -p /usr/local/go/bin
  - wget https://golang.org/dl/go1.16.5.linux-amd64.tar.gz
  - tar -C /usr/local -xzf go1.16.5.linux-amd64.tar.gz
  - export PATH=$PATH:/usr/local/go/bin
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
  - echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt-get update  && apt-get install -y docker-ce docker-ce-cli containerd.io
  - make -d cmd/agent/agent cmd/agentctl/agentctl
  - make -d test
  - RELEASE_TAG=v0.0.0 make -d test-packages

volumes:
- name: docker
  host: 
    path: /var/run/docker.sock

---
kind: pipeline
type: docker
name: Containerize
platform:
  os: linux
  arch: amd64

steps:
- name: Build Agent Container
  image: docker
  volumes:
  - name: docker
    path: /var/run/docker.sock
  commands:
  - apk update && apk add make bash wget git qemu
  - wget https://github.com/docker/buildx/releases/download/v0.5.1/buildx-v0.5.1.linux-amd64
  - mkdir -p ~/.docker/cli-plugins 
  - cp buildx-v0.5.1.linux-amd64 ~/.docker/cli-plugins/docker-buildx
  - chmod a+x ~/.docker/cli-plugins/docker-buildx
  - docker buildx create --use
  - CROSS_BUILD=true RELEASE_BUILD=true make agent-image
- name: Build Agentctl Container
  image: docker
  volumes:
  - name: docker
    path: /var/run/docker.sock
  commands:
  - apk update && apk add make bash wget git qemu
  - wget https://github.com/docker/buildx/releases/download/v0.5.1/buildx-v0.5.1.linux-amd64
  - mkdir -p ~/.docker/cli-plugins 
  - cp buildx-v0.5.1.linux-amd64 ~/.docker/cli-plugins/docker-buildx
  - chmod a+x ~/.docker/cli-plugins/docker-buildx
  - docker buildx create --use
  - CROSS_BUILD=true RELEASE_BUILD=true make agentctl-image

volumes:
- name: docker
  host: 
    path: /var/run/docker.sock
